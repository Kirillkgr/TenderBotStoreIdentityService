I'll open [TASK.md](cci:7://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/TASK.md:0:0-0:0) to see
its current contents, then add a detailed BL-2 RBAC decomposition section with clear subtasks and DoD so you can track
and resume easily.

Отлично. Ниже — подробная декомпозиция BL-2-RBAC с чёткими шагами, DoD и планом по backend/frontend/докам/тестам/CI. Я
подготовил это в формате, который можно целиком вставить
в [TASK.md](cci:7://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/TASK.md:0:0-0:0). Если хочешь,
могу в следующем шаге сам записать это в файл.

# BL-2-RBAC (High) — RBAC на Membership

- Цель: ввести роли на уровне Membership и валидацию доступа в API/сервисах/фронте для ролей
  Owner/Admin/Cashier/Cook/Client.
- Контекст: права определяются активным контекстом (JWT клеймы: membershipId/masterId/brandId/locationId). Никакой
  “сборной солянки” из других membership — только текущий.
- Область: IdentityService (+ фронт), без изменения стабильных сервисов и без касания бизнес-логики других BL.

## 1. Модель и миграции (Liquibase)

- Добавить поле роли в `UserMembership`:
  - Вариант A (проще): `role` (enum: OWNER, ADMIN, CASHIER, COOK, CLIENT).
  -
  Индексы/уникальность: [(user_id, master_id, brand_id, location_id, role)](cci:1://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/src/test/java/kirillzhdanov/identityservice/service/BrandServiceIsolationTest.java:13:4-28:5) —
  опционально; минимум — индексы
  по [(user_id)](cci:1://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/src/test/java/kirillzhdanov/identityservice/service/BrandServiceIsolationTest.java:13:4-28:5), [(master_id)](cci:1://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/src/test/java/kirillzhdanov/identityservice/service/BrandServiceIsolationTest.java:13:4-28:5).
- Сидинг базовых ролей: уже есть базовая таблица `roles` для системы — не пересекать. Для Membership‑ролей использовать
  enum/столбец в `user_memberships`.
- Миграция:
  - Добавить столбец `role` NOT NULL с дефолтом `CLIENT` (или nullable с апдейтом существующих данных).
  - Индексы и FKs — как нужно.

DoD (модель/DDL):

- Liquibase изменяет схему без падений.
- Тесты поднимаются с Liquibase в интеграционной среде.

## 2. Доменные правила (Security Policy)

- Матрица доступов по ролям (минимальная, уточняется в BL‑8 SHOP и дальнейших):
  - OWNER: полный доступ в пределах master (управление брендами, пользователями, товарами и т.д.).
  - ADMIN: почти полный доступ в master, кроме критических операций (например, удаление OWNER/передача владения).
  - CASHIER: операции заказа/продаж, просмотр каталога, без админ‑действий.
  - COOK: операции кухни, просмотр рецептов и заказов на готовку, без финанса/админки.
  - CLIENT: доступ к публичным/клиентским ручкам, без админ‑операций.
- Принцип: всё, что затрагивает master/brand/location — разрешено, если роль включает право на соответствующий ресурс;
  иначе 403 или 404 (маскировка чужих сущностей).
- Контекст обязателен на защищённых ручках: если нет — 401/403.

DoD (policy):

- Описана явная простая матрица.
- Рекомендованные коды: 401 без аутентификации, 403 без прав, 404 для чужих сущностей.

## 3. Backend — реализация проверок

- Контекст:
  - Использовать уже существующий `TenantContext` (masterId/brandId/locationId) и `membershipId`.
  - Добавить `TenantContext.getRoleOrThrow()` (или аналог) — роль активного membership.
- Авторизация:
  - Метод‑уровень: предикаты аннотациями на сервисах/контроллерах (например, `@PreAuthorize` с кастомным
    `PermissionEvaluator`) либо ручная проверка в сервисах.
  - Базовые гварды:
    - ADMIN/OWNER: доступ к админ‑операциям каталога.
    - CASHIER: доступ к созданию/обновлению заказов/чек-аут потока (в пределах master/brand).
    - COOK: доступ к операциям кухни (например, статус “готовится”).
    - CLIENT: доступ к клиентским ручкам (просмотр каталога, создание заказа от лица клиента — по бизнес‑решению).
- Репозитории/сервисы:
  - Все выборки/операции — в контексте master/brand/location (уже есть каркас). Роль дополняет проверку.
- Исключения:
  - Чужие сущности → 404 (если маскируем).
  - Недостаточно прав → 403.
  - Без контекста → 401 или 403 (в зависимости от текущей политики).

Задачи (backend):

- __B2‑BK‑1__ Внести enum RoleMembership в код и валидацию (OWNER/ADMIN/CASHIER/COOK/CLIENT).
- __B2‑BK‑2__ Liquibase: колонка `user_memberships.role`, индексы.
- __B2‑BK‑3__ Расширить `TenantContext` (+ извлечение роли).
- __B2‑BK‑4__ Добавить слой авторизации (аннотации или сервисный гвард).
- __B2‑BK‑5__ Пройти по ключевым контроллерам (бренды/теги/товары/чек‑аут) и добавить проверки ролей.
- __B2‑BK‑6__ Обновить обработку ошибок (401/403/404) по правилам.

DoD (backend):

- Покрывающие интеграционные тесты по ролям.
- Явная проверка ролей на ключевых ручках.
- Отсутствие регрессий по BL‑1.

## 4. Backend — тесты

- Интеграционные тесты по ролям (наборы):
  - OWNER/ADMIN: доступно X, недоступно Y (если есть исключения).
  - CASHIER: доступ к заказам/продажам, нет доступа к админ‑операциям каталога.
  - COOK: операции кухни, без финанса/админки.
  - CLIENT: только клиентские действия.
- Проверить:
  - Контекст‑свитч меняет роль.
  - Маскировка чужих сущностей (404).
  - Коды 401/403/404 соответствуют правилам.

Задачи (tests):

- __B2‑TS‑1__ Тестовые фикстуры: создать по одному membership на роли для одного пользователя.
- __B2‑TS‑2__ Набор интеграционных тестов по ролям.
- __B2‑TS‑3__ Smoke‑тесты контекст‑свитча и прав.

DoD (tests):

- Тесты зелёные в CI; покрывают все роли.

## 5. Frontend — проверка ролей и контекста

- Route guards:
  - На уровне роутера: страницы админки доступны OWNER/ADMIN; кухня — COOK; касса — CASHIER; клиентские — CLIENT/guest
    где нужно.
- UI‑видимость:
  - Кнопки/действия скрываются/дизейблятся при отсутствии прав.
- Контекст:
  - После логина → список memberships → выбор → `context/switch` → новый accessToken.
  - Рендеринг UI в соответствии с ролью активного контекста.
- Тесты:
  - Витест/мок: эмулировать разные роли и проверять доступность элементов/страниц.

Задачи (frontend):

- __B2‑FE‑1__ Добавить слой ролей в фронтовый store/контекст.
- __B2‑FE‑2__ Route guards по ролям.
- __B2‑FE‑3__ Скрытие/дизейбл UI‑элементов по роли.
- __B2‑FE‑4__ E2E/мок‑тесты ролей и контекста.

DoD (frontend):

- Роуты/элементы корректно ограничиваются по ролям.
- Smoke‑тест роли/контекста зелёный.

## 6. Документация

- `docs/services/rbac.md` (кратко и стабильно):
  - Роли, матрица, примеры 401/403/404.
  - Принцип “активное membership определяет доступ”.
- README:
  - Ссылка на RBAC‑страницу.
- Swagger/OpenAPI:
  - Теги/описание прав на эндпоинтах (минимальная пометка).

Задачи (docs):

- __B2‑DC‑1__ Создать `docs/services/rbac.md` (матрица и правила).
- __B2‑DC‑2__ Дополнить README ссылкой.
- __B2‑DC‑3__ При необходимости — теги/описания в OpenAPI.

DoD (docs):

- Страница RBAC в Wiki/Docs доступна, короткая и понятная.

## 7. CI/CD

- Запуск интеграционных тестов с ролями.
- Сборка доков (уже есть) — обновить при добавлении новой страницы.
- Опционально — статический анализ/линт.

Задачи (ci):

- __B2‑CI‑1__ Убедиться, что интеграционные тесты RBAC запускаются в CI.
- __B2‑CI‑2__ Проверка сборки docs после добавления страницы RBAC.

DoD (ci):

- Pipeline зелёный; отчёты тестов присутствуют.

## 8. План работ (последовательность)

1) Миграции `user_memberships.role` (Liquibase).
2) Enum роли в коде и извлечение роли из контекста.
3) Добавить гварды/проверки на сервисах/контроллерах (начать с каталога).
4) Интеграционные тесты по ролям.
5) Frontend: route guards и UI‑видимость.
6) Документация (RBAC).
7) CI: тесты и сборка доков.

## 9. DoD BL‑2 (итог)

- Схема БД обновлена (Liquibase), роли на membership.
- Backend: проверки ролей в ключевых эндпоинтах, коды ошибок корректные.
- Frontend: guards и UI‑правила в зависимости от роли.
- Тесты: покрытие всех ролей (integration + smoke).
- Документация: страница RBAC; README содержит ссылку.
- CI зелёный.

---

Хочешь — запишу это
в [TASK.md](cci:7://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/TASK.md:0:0-0:0) одном куском.
Если ок, напиши “запиши”, и я добавлю раздел BL‑2‑RBAC
в [TASK.md](cci:7://file:///C:/Users/RillG/IdeaProjects/TenderBotStoreIdentityService/TASK.md:0:0-0:0).