# TenderBotStore — Техническое задание и дорожная карта

Этот документ описывает функциональные требования для развития текущего репозитория до полноценного интернет‑магазина (FOOD/eCom) с онлайн‑оплатой по СБП, заказами и доставкой, Telegram‑ботом, модулями персонала и склада, расчётом себестоимости и БЖУ. Включает критерии приёмки/тесты, API/БД на уровне контракта, инструкции по деплою и список задач.

## 1. Обзор и цели
- Создать продуктовый интернет‑магазин с каталогом блюд/товаров.
- Поддержать онлайн‑оплату по СБП (Система быстрых платежей) через подходящего провайдера (YooKassa/Tinkoff/Sber/CloudPayments с СБП).
- Реализовать процесс заказа с доставкой/самовывозом, статусы и трекинг.
- Интегрировать Telegram‑бот для уведомлений и заказов.
- Внедрить модули: персонал (ролевая модель, смены), склад (остатки, партии, движения), калькуляцию себестоимости (в т.ч. рецептуры/техкарты), автоматический расчёт БЖУ по ингредиентам.
- Обеспечить CI/CD (уже частично настроено) и документацию API (OpenAPI/Swagger).

## 2. Архитектура (целевое состояние)
- Сервисы:
  - Identity (уже есть): аутентификация/авторизация, JWT, пользователи, роли.
  - Catalog: бренды, теги, ингредиенты, товары, рецепты/техкарты, БЖУ.
  - Orders: корзина, заказы, доставка/самовывоз, статусы, чек‑аут.
  - Payments: интеграция СБП, состояния платежей, webhooks.
  - Warehouse: склады, остатки, партии, списания/приход, инвентаризация.
  - Staff: сотрудники, роли/доступы, расписание смен, начисления.
  - Notifications: Telegram‑бот, e‑mail, push/webhook.
- API‑шлюз/фронт: Vue + Vite (уже есть). Настройка API‑клиентов и прокси для dev.
- БД: PostgreSQL (существует). Миграции — Liquibase (единый changelog для монолита).
- Асинхронность: Kafka (в проекте уже присутствует зависимость) для событийных интеграций (заказ создан, списания склада, оплата подтверждена и т.д.).

## 3. Доменные сущности (черновик)
- Пользователь: id, email, phone, пароль (хеш), роли, адреса, preferences.
- Роль/Права: ADMIN, MANAGER, COURIER, CHEF, USER.
- Бренд: id, name, описание, изображения.
- Тег/Группа тегов: id, name, parent(optional).
- Ингредиент: id, name, ед.изм., БЖУ на 100г/ед., цена закупки, поставщик.
- Рецептура/Техкарта: id, name, состав (многие‑ко‑многим ингредиенты с количеством), выход, БЖУ и себестоимость (расчетные), алергенность.
- Товар/Блюдо (SKU): id, name, brand, tags, baseRecipe(optional), цена, фото, опубликован.
- Склад: id, name, адрес, список остатков по ингредиентам/партиям, минимальные остатки.
- Движение склада: приход, списание, перемещение, инвентаризация (документ, строки).
- Заказ: id, пользователь, позиции (SKU+qty+цена+скидки), сумма, способ доставки, адрес, слот доставки, статус (CREATED, RESERVED, PAID, COOKING, READY, SHIPPED, DELIVERED, CANCELED), трекинг, платеж.
- Платеж: id, заказ, провайдер, метод (СБП), статус (PENDING, CONFIRMED, FAILED, REFUNDED), суммы, ссылки (deep link/qr), webhooks.
- Персонал: сотрудник, роль, смены, задания, payroll (упрощенно: ставка/почасовая), активность.
- Уведомления: канал, шаблон, событие.

## 4. API (черновик контрактов)
Рекомендуется springdoc-openapi и Swagger UI для всех сервисов. Ниже ключевые ресурсы (REST):

- Auth/Identity (существует):
  - POST /api/auth/register, /login, /refresh, /logout
  - GET /api/users/me, /users/{id}
  - RBAC: роли/привилегии

- Catalog:
  - (Частично реализовано) Бренды и групповые теги:
    - GET/POST/PUT/DELETE /api/brands
    - GET/POST/PUT/DELETE /api/group-tags
  - Теги (простые) при необходимости
  - GET/POST/PUT/DELETE /api/ingredients
  - GET/POST/PUT/DELETE /api/recipes (состав, расчет БЖУ/себестоимости сервером)
  - (Частично реализовано) Товары (SKU): GET/POST/PUT/DELETE /api/products — расширить под рецепты, БЖУ, архив

- Warehouse:
  - GET/POST/PUT/DELETE /api/warehouses
  - GET/POST /api/warehouse/receipts (приход), /writeoffs (списание), /moves (перемещение)
  - GET /api/warehouse/stocks?sku|ingredient&warehouseId

- Orders:
  - GET/POST /api/cart, /api/cart/items
  - POST /api/orders (создание из корзины)
  - GET /api/orders/{id}, /api/orders?status=..., PATCH /api/orders/{id}/status

- Payments (СБП):
  - POST /api/payments/sbp/create — создать платеж (генерация QR/ссылки)
  - GET /api/payments/{id} — статус
  - POST /api/payments/webhook/sbp — webhook от провайдера

- Notifications (Telegram):
  - POST /api/telegram/webhook — приём обновлений (если бот в webhook‑режиме)
  - POST /api/telegram/send — служебная отправка сообщений/уведомлений

- Staff:
  - GET/POST/PUT/DELETE /api/staff
  - GET/POST /api/shifts, /api/tasks

## 5. Схема БД (эскиз)
- identity_* (существующие таблицы пользователей/ролей из Identity)
- catalog_brand, catalog_tag, catalog_ingredient, catalog_recipe, catalog_recipe_ingredient, catalog_product
- wh_warehouse, wh_stock, wh_batch, wh_doc, wh_doc_line
- ord_order, ord_order_item, ord_delivery, ord_status_history
- pay_payment
- staff_employee, staff_shift, staff_task
- notif_subscription, notif_template

## 6. Бизнес‑правила и вычисления
- Себестоимость блюда: сумма(ингредиент.ценаЗакупки × количество) + накладные (коэф./%) → на выход.
- БЖУ блюда: сумма по ингредиентам, нормированная на выход рецепта (на 100 г/порцию).
- Резервирование склада: по подтверждению заказа (или по оплате — выбирается заранее), списание — при выдаче на кухню/отгрузке.
- СБП: создание заказа → создание платежа → редирект/QR → подтверждение через webhook → изменение статуса заказа.
- Telegram: уведомления клиенту (статусы), менеджеру (новый заказ/низкие остатки), курьеру (назначение).

## 7. Нефункциональные требования
- Безопасность: RBAC, валидация, ограничение CORS (`application.yml` уже содержит список), защита вебхуков подписью провайдера.
- Наблюдаемость: логирование (logback), метрики (Micrometer), трассировка (опц. OpenTelemetry).
- Тестирование: unit+slice+integration (Testcontainers для Postgres/Kafka), E2E (фронт против compose).
- Производительность: пагинация, кэширование справочников, индексы.

## 8. Инструкции по деплою
- Прод: Docker images (CI в `.github/workflows/CI-CD-PROJECT.yml`), деплой на сервер через `starts3.sh`, `docker-compose.yml` (postgres, backend, frontend) + nginx конфиг для фронта.
- Dev: `docker-compose-test.yml` (postgres, kafka, zookeeper). Локально: Spring Boot (порт 9900), Vite dev (5173) с прокси.
- Секреты: ключи JWT, СБП провайдера, токен Telegram‑бота — через secrets/env.

---

# Критерии приёмки и тесты (по модулям)

## A. Оплата (СБП)
- CRITERIA
  - Создание платежа для заказа возвращает QR/URL.
  - Webhook подтверждения меняет статус платежа на CONFIRMED, заказ → PAID.
  - Обработка ошибок/повторов, проверка подписи, идемпотентность.
- TESTS
  - Unit: маппинг запросов/ответов провайдера.
  - Integration: webhook controller с подписью, переходы статусов заказа.

## B. Заказы с доставкой
- CRITERIA
  - Создание заказа из корзины, валидация адреса/слота.
  - Статусы и их переходы, история статусов.
  - Расчет суммы (цены, скидки, доставка), печать/экспорт чека (опц.).
- TESTS
  - Unit: сервис корзины и заказа.
  - Integration: создание → оплата → изменение статусов.

## C. Telegram‑бот
- CRITERIA
  - Получение webhook‑обновлений, обработка команд /start, /order_status, /help.
  - Отправка уведомлений по событиям (заказ создан/оплачен/готов).
  - Линковка Telegram chatId с пользователем.
- TESTS
  - Unit: парсинг апдейтов.
  - Integration: webhook controller.

## D. Персонал
- CRITERIA
  - Создание сотрудников, роли/права, расписание смен.
  - Назначение задач (готовка, сборка, доставка), статус задач.
- TESTS
  - Unit: сервис смен/задач.
  - Integration: RBAC и доступ к эндпоинтам.

## E. Склад
- CRITERIA
  - Учёт остатков по ингредиентам и партиям.
  - Приход/списание/перемещение, инвентаризация, мин. остатки (уведомления).
- TESTS
  - Unit: калькуляция остатков.
  - Integration: документы движения, связи с заказами/кухней.

## F. Себестоимость и БЖУ
- CRITERIA
  - Автоматический расчёт себестоимости блюда по техкарте.
  - Автоматический расчёт БЖУ на 100 г и на порцию.
  - Актуализация при изменении цены закупки/состава.
- TESTS
  - Unit: формулы калькуляции, пограничные кейсы.

---

# ГАП‑анализ каталога (Brand / GroupTag / Product) — недостающие эндпоинты

С учетом текущих контроллеров (`BrandController`, `GroupTagController`, `ProductController`) для полноценного управления с фронта не хватает следующего.

## Brand (`/auth/v1/brands`)
- [GET] /auth/v1/brands?page=&size=&sort= — пагинация/сортировка.
- [GET] /auth/v1/brands/search?q= — поиск по `name`/`organizationName`.
- [PATCH] /auth/v1/brands/{id}/token — установка/обновление `telegramBotToken`.
- [GET] /auth/v1/brands/{id}/users — список пользователей, привязанных к бренду.
- [POST] /auth/v1/brands/{id}/users — массовое назначение пользователей (список id).
- [DELETE] /auth/v1/brands/{id} — мягкое удаление (если нужно) с валидацией отсутствия критичных связей.

## GroupTag (`/auth/v1/group-tags`)
- [PUT] /auth/v1/group-tags/{id} — переименование тега.
- [PATCH] /auth/v1/group-tags/{id}/move?parentId= — смена родителя; пересчет `path`/`level` и потомков.
- [DELETE] /auth/v1/group-tags/{id} — удаление тега (валидация: нет вложенных групп/товаров или принудительный перенос).
- [GET] /auth/v1/group-tags/breadcrumbs/{id} — хлебные крошки по `path`.
- [GET] /auth/v1/group-tags/by-brand/{brandId}?parentId=&page=&size=&sort= — пагинация/сортировка выборки.

## Product (`/auth/v1/products`)
- [GET] /auth/v1/products/{productId} — получить карточку товара.
- [PUT] /auth/v1/products/{productId} — редактирование (name, description, price, promoPrice, visible)
- [PATCH] /auth/v1/products/{productId}/brand?brandId= — смена бренда (с валидацией групп).
- [GET] /auth/v1/products/by-brand/{brandId}?groupTagId=&visibleOnly=&page=&size=&sort=&q= — добавить пагинацию/сортировку/поиск.
- [GET] /auth/v1/products/archive?brandId=&page=&size=&sort=&q= — список архива по бренду.
- [POST] /auth/v1/products/archive/{archiveId}/restore — восстановление из архива (если возможно) в исходную или указанную группу.
- [DELETE] /auth/v1/products/archive/purge?olderThanDays=90 — ручная очистка архива (только ADMIN), будет дублировать плановую.
- [PATCH] /auth/v1/products/{productId}/images — загрузка/обновление изображений (если требуется во фронте).

Примечание: текущая логика удаления переносит товар в `ProductArchive` и удаляет из `products`. Для фич восстановления нужны обратные маппинги (brand/group по `brandId`/`groupTagId`).


# Пакет задач (как запросы к ассистенту)

Каждая задача формулируется как самостоятельный запрос к ассистенту (мне), чтобы её можно было выполнить без дополнительного контекста. Если чего‑то не хватает, я сам задам уточняющие вопросы.

1) Backend — Добавить springdoc-openapi
- Реализуй интеграцию `springdoc-openapi-starter-webmvc-ui` в существующий Spring Boot проект (`pom.xml`, конфиг), открой Swagger UI на `/swagger-ui.html`. Уточни порты и CORS, основываясь на `src/main/resources/application.yml`.

2) Backend — Ввести Liquibase миграции (baseline от текущей схемы)
- Не включая миграции в рантайм до подтверждения, подготовь мастер‑чейнджлог и базовые changelog‑файлы на основе уже существующих JPA‑моделей: `User`, `Role`, `Department`, `Brand`, `GroupTag`, `Product`, `ProductArchive`, `Token`.
- Сформируй структуру под будущие модули (эскиз из раздела "Схема БД"), но отдельными changelog'ами, не нарушая текущие таблицы. Уточни недостающие поля вопросами.

3) Backend — Расширение Catalog (ingredients/recipes + расчеты)
- Добавь сущности, DTO, мапперы и контроллеры для: `Ingredient`, `Recipe` (+ `RecipeIngredient`).
- Интегрируй продукты с рецептом: серверный расчет себестоимости и БЖУ на 100 г/порцию, хранение рассчитанных значений в кэше полей продукта.
- Не дублируй уже реализованные Brand/GroupTag/Product; расширяй существующие контроллеры/сервисы.
- Описать контракты в OpenAPI.

4) Backend — Модуль Warehouse
- Реализуй склад: `Warehouse`, `Stock`, `Batch`, документы прихода/списания/перемещения и их строки. Добавь API для инвентаризаций и отчета остатков. Продумай связи с заказами (резервирование/списание).

5) Backend — Модуль Orders
- Реализуй корзину, заказ, статусы, историю статусов. Подготовь API для создания заказа, просмотра, смены статусов. Интегрируй Kafka события (order_created, order_paid, stock_reserve, stock_writeoff).

6) Backend — Модуль Payments (СБП)
- Интегрируй провайдера СБП (предложи 2-3 варианта: YooKassa/Tinkoff/Sber) и реализуй эндпоинты: создать платеж (QR/URL), получить статус, webhook. Обеспечь верификацию подписи, идемпотентность и транзакционность смены статусов заказа.

7) Backend — Notifications (Telegram)
- Добавь Telegram‑бот: настрой webhook, обработку команд /start, /order_status, /help. Реализуй связывание chatId c пользователем и отправку уведомлений по событиям. Продумай retry/backoff.

8) Backend — Staff (расширение)
- Используй текущие модели `User`, `Role`, `Department`. Добавь сущности смен и задач, RBAC на эндпоинты, отчеты по сменам.

9) Frontend — Клиентские сервисы и страницы каталога
- Добавь сервисы API и страницы: список товаров, карточка товара, добавление в корзину, фильтрация по тегам/брендам. Учти текущее устройство фронта (`Front/src/...`).

10) Frontend — Корзина, заказ, оплата СБП
- Реализуй страницу корзины и оформления заказа, получение QR/ссылки СБП, обработку результата платежа и статуса заказа. Добавь уведомления и редиректы.

11) Frontend — Профиль, адреса, заказы
- Реализуй раздел "Мои заказы", адреса доставки, статусы и трекинг.

12) Frontend — Страницы персонала (admin)
- Реализуй управление ингредиентами, техкартами, товарами, складом, сменами сотрудников. Учти разграничение доступа по ролям (RBAC).

13) CI/CD — Тесты и предпросмотр
- Дополни `test-backend-frontend-ci.yml` сценариями для интеграционных тестов бэка с Testcontainers и e2e фронта (опционально Playwright/Cypress). Публикуй отчеты.

14) Observability — Логи/Метрики/Trace
- Включи Micrometer + Prometheus endpoint, опционально OTEL. Добавь структурированные логи (JSON) и correlationId.

15) Безопасность — Вебхуки и секреты
- Добавь валидацию подписи вебхуков платежного провайдера, секреты — через ENV/Secrets. Защити критичные эндпоинты.

16) Документация — README/DEPLOYMENT
- Обнови README с локальным запуском (dev proxy Vite → Spring), переменными окружения (JWT, СБП, Telegram), Docker Compose (prod/dev), ссылками на Swagger.

17) Data — Импорт/экспорт справочников
- Реализуй импорт/экспорт CSV/JSON для ингредиентов, рецептов, товаров.

18) Отчеты — Себестоимость и маржинальность
- Добавь отчеты по себестоимости, марже и ABC/XYZ анализу по SKU и категориям.

19) Notifications — почта/SMS (опционально)
- Добавь e‑mail и/или SMS уведомления для ключевых событий (регистрация, заказ, доставка).

20) Backend — Политика архива продуктов
- Реализуй плановую очистку архива: удалять записи из `ProductArchive`, старше 90 дней. 
- Добавь админ‑эндпоинт для просмотра/восстановления из архива (при наличии связей/данных) и интеграционные тесты.

20) Вопросы по уточнению (перечень)
- Подтверди провайдера СБП и режим (QR/DeepLink, комиссии, валюты).
- Подтверди модель доставки (собственная/курьерская служба, слоты, геозоны, стоимость).
- Уточни номенклатуру: товары vs блюда, есть ли полуфабрикаты, варианты/модификаторы.
- Уточни учетные политики склада (FIFO/FEFO), партии и срок годности.
- Подтверди роли и права персонала, схему зарплат/начислений.
- Нужны ли интеграции с 1С/МойСклад/CRM?

---

# Следующие шаги (план внедрения)
1. Подключить springdoc-openapi; подготовить Liquibase changelog (baseline без активации в рантайме до согласования).
2. Довести каталог до полной управляемости: реализовать недостающие эндпоинты Brand/GroupTag/Product (см. гап‑анализ выше), добавить пагинацию/поиск/сортировки и работу с архивом (список/восстановление/очистка), не ломая текущие контракты.
3. Расширить Catalog: ингредиенты/рецепты с расчетом БЖУ/себестоимости; интеграция с существующим `Product`.
4. Реализовать Orders + Payments (СБП) и базовый Happy‑path от витрины до оплаты.
5. Добавить Warehouse и резервирование/списания по заказам.
6. Интегрировать Telegram‑бота и уведомления.
7. Политика архива (90 дней) + админ восстановление.
8. Расширить фронт: корзина/чекаут/заказы/админ.
9. Наблюдаемость, тесты, документация, CI/CD.
