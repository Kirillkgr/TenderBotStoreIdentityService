# Многотенантность и контекст

Эта страница объясняет простыми словами: как мы разделяем данные между разными владельцами (тенантами) и как фронт/бэк
понимают «в каком контексте» сейчас работает пользователь.

## Зачем это нужно

- У каждого владельца свои бренды, товары, заказы. Другие владельцы не должны их видеть.
- Один и тот же пользователь может работать в нескольких контекстах (например, сегодня он в бренде A, завтра — в бренде
  B).

## Что такое контекст

Контекст — это набор идентификаторов, который добавляется в токен доступа (JWT):

- membershipId — членство пользователя (связь user ↔ master/brand/location)
- masterId — владелец (тенант)
- brandId — бренд (опционально)
- locationId — локация/пункт выдачи (опционально)

Backend читает эти поля из JWT и автоматически фильтрует данные по ним.

## Как выбрать контекст

1. Пользователь логинится и получает обычный accessToken (без контекста).
2. Фронт показывает список membership (его «роли/доступы») и позволяет выбрать один.
3. Фронт вызывает `POST /auth/v1/context/switch` с `membershipId` (и, при необходимости, brandId/locationId).
4. Backend возвращает новый accessToken, в котором уже зашиты значения context.

## Заголовки (dev‑режим)

Для локальной отладки разрешён «лёгкий контекст» через заголовок:

- `X-Master-Id: <id>` — подмена текущего master. Работает только в профиле dev и только для упрощения тестирования.

## Что проверяют тесты

- Репозитории и сервисы видят только данные текущего master/brand.
- Публичные ручки `/menu/**` доступны без контекста.
- Защищённые `/auth/v1/**` требуют либо JWT с контекстом, либо дадут 401/403.

## Ошибки доступа

Если пользователь пытается получить сущность другого владельца:

- Сервис вернёт 404 (как будто сущности в его контексте нет) или 403 (если явно запрещено политикой).

## Мини‑глоссарий

- «Тенант» (tenant) — владелец данных (у нас это MasterAccount).
- «Контекст» — выбранное «рабочее пространство» (master/brand/location) для текущей сессии.
