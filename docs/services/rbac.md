# RBAC (BL-2) — роли на уровне Membership

- **[Цель]** Ввести простую и предсказуемую модель доступа: все права определяются активным контекстом (membership).
- **[Принцип]** Один пользователь (`User`) может иметь несколько `UserMembership` с разными ролями и контекстами. В
  каждый момент времени активен ровно один контекст, выбранный через `membershipId` (клейм в JWT). Только активное
  membership определяет доступ.

## Роли

- **OWNER** — владелец master-аккаунта, полный доступ в пределах своего `masterId`.
- **ADMIN** — администратор master-аккаунта, почти полный доступ (без критически опасных операций владельца).
- **CASHIER** — кассир: операции заказов/продаж.
- **COOK** — повар/кухня: операции цеха/готовки.
- **CLIENT** — клиент: публичные и клиентские операции.

Хранение: колонка `user_membership.role` (`OWNER|ADMIN|CASHIER|COOK|CLIENT`, NOT NULL, default `CLIENT`). См. миграции:
`src/main/resources/db/changelog/2025/10/01-01-changelog.xml`.

## Контекст и клеймы JWT

Минимальный набор клеймов:

- `membershipId` — идентификатор активного membership (обязателен на защищённых ручках)
- `masterId`, опц. `brandId`, `locationId` — область данных
- `role` — роль активного membership

> Никакой агрегации ролей из других membership. Только активный контекст определяет привилегии.

## Матрица (минимальная)

- **OWNER**: полный доступ в пределах master (управление брендами/персоналом/каталогом/заказами и т.д.).
- **ADMIN**: почти полный доступ в пределах master; без операций, предназначенных только для владельца.
- **CASHIER**: создание/обновление заказов, операции продажи; нет доступа к админ‑операциям каталога/персонала.
- **COOK**: операции кухни (статусы приготовления и т.п.); нет доступа к финансам/админке.
- **CLIENT**: публичные/клиентские ручки; без админ‑операций.

Практические предикаты (см. код): `RoleMembership.isOwnerOrAdmin()`, `canManageCatalog()`.

## Примеры кодов ошибок

- **401 Unauthorized** — пользователь не аутентифицирован или отсутствует валидный JWT.
- **403 Forbidden** — пользователь аутентифицирован, но роль активного membership не даёт права на операцию.
- **404 Not Found** — маскировка чужих сущностей (ресурс находится вне области `master/brand/location`).

Рекомендации:

- На проверяемых ручках сначала валидируйте контекст (наличие membership/tenant-контекста), затем роль.
- Для чужих сущностей (например, попытка доступа к объекту другого `masterId`) возвращайте 404.

## Backend: ключевые точки

- Контекст и роль: `TenantContext` (`getRoleOrThrow()`), файл
  `src/main/java/kirillzhdanov/identityservice/tenant/TenantContext.java`.
- Гвард авторизации: `RbacGuard` (методы `requireOwnerOrAdmin()`, `requireCashier()` и т.п.), файл
  `src/main/java/kirillzhdanov/identityservice/security/RbacGuard.java`.
- Enum ролей: `RoleMembership`, файл `src/main/java/kirillzhdanov/identityservice/model/master/RoleMembership.java`.

## Frontend: проверки

- Route guards для страниц админки/кухни/кассы.
- Скрытие/дизейбл UI‑элементов в зависимости от роли из текущего контекста.
- После `context/switch` обязателен пересчёт роли в сторе и перерисовка UI.

## DoD (для BL‑2)

- Миграции применяются без ошибок; колонка `role` обязательна и ограничена CHECK‑constraint.
- Авторизационные проверки присутствуют на ключевых ручках в соответствии с матрицей.
- Интеграционные тесты покрывают роли OWNER/ADMIN/CASHIER/COOK/CLIENT, проверяют 401/403/404 и свитч контекста.
- Frontend ограничивает доступ к страницам/элементам согласно роли.
